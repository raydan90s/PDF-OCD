# ğŸ“„ PDF OCR Server

Este proyecto es un **backend en FastAPI** que recibe uno o varios archivos PDF, los convierte en imÃ¡genes por pÃ¡gina, las sube a **Cloudinary** y envÃ­a los resultados **PDF por PDF** a un **webhook de n8n** para su procesamiento OCR (por ejemplo con Google Vision).

---

## ğŸ§  Arquitectura general

```
Cliente / Frontend
        â”‚
        â–¼
FastAPI (/procesar-pdfs)
        â”‚
        â”œâ”€ Convierte PDF â†’ imÃ¡genes (por pÃ¡gina)
        â”œâ”€ Sube imÃ¡genes a Cloudinary
        â””â”€ EnvÃ­a resultados a n8n (1 PDF por ejecuciÃ³n)
                                â”‚
                                â–¼
                         n8n Workflow (OCR / Vision)
```

---

## ğŸš€ Flujo de funcionamiento

1. Se envÃ­an **uno o varios PDFs** al endpoint `/procesar-pdfs`.
2. Por cada PDF:

   * Se valida que sea un archivo vÃ¡lido.
   * Se convierte cada pÃ¡gina a imagen (`pypdfium2`).
   * Cada imagen se sube a Cloudinary.
   * Se construye un payload con:

     * nombre del archivo
     * nÃºmero de pÃ¡ginas
     * URLs de las imÃ¡genes
3. **Cada PDF se envÃ­a individualmente** al webhook de n8n.
4. n8n procesa cada PDF en una **ejecuciÃ³n independiente**.

---

## ğŸ“ Estructura del proyecto

```
app/
â”œâ”€â”€ main.py                     # Entrada principal FastAPI
â”œâ”€â”€ config.py                   # Variables de entorno
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ pdf_service.py          # PDF â†’ imÃ¡genes
â”‚   â”œâ”€â”€ cloudinary_service.py   # Subida de imÃ¡genes
â”‚   â””â”€â”€ webhook_service.py      # EnvÃ­o a n8n
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ logger.py               # Logger centralizado
logs/
â”‚   â””â”€â”€ app.log                 # Logs rotativos
venv/
.env
```

---

## âš™ï¸ Requisitos

* Python **3.10+**
* Cuenta de **Cloudinary**
* Instancia de **n8n** con webhook activo

---

## ğŸ“¦ InstalaciÃ³n

### 1ï¸âƒ£ Crear entorno virtual

```bash
python -m venv venv
source venv/bin/activate   # Linux/Mac
venv\Scripts\activate      # Windows
```

### 2ï¸âƒ£ Instalar dependencias

```bash
pip install -r requirements.txt
```

---

## ğŸ” Variables de entorno (.env)

Crear un archivo `.env` en la raÃ­z del proyecto:

```env
# FastAPI
PDF_RENDER_SCALE=2.0

# Cloudinary
CLOUDINARY_CLOUD_NAME=xxxx
CLOUDINARY_API_KEY=xxxx
CLOUDINARY_API_SECRET=xxxx
CLOUDINARY_FOLDER=pdf_ocr

# n8n
N8N_WEBHOOK_URL=https://n8n.tudominio.com/webhook/pdf-ocr
```

âš ï¸ **Importante**: usar siempre `/webhook/` y NO `/webhook-test/` para producciÃ³n.

---

## â–¶ï¸ Ejecutar el servidor

```bash
uvicorn app.main:app --reload
```

Servidor disponible en:

```
http://127.0.0.1:8000
```

DocumentaciÃ³n automÃ¡tica:

```
http://127.0.0.1:8000/docs
```

---

## ğŸ“¤ Endpoint principal

### `POST /procesar-pdfs`

**Tipo:** `multipart/form-data`

**Campo:**

* `pdfs`: uno o varios archivos PDF

### Respuesta:

```json
{
  "status": "ok",
  "total_files": 1,
  "files": [
    {
      "file": "archivo.pdf",
      "pages": 2,
      "images": [
        "https://cloudinary/...page_1.png",
        "https://cloudinary/...page_2.png"
      ]
    }
  ]
}
```

---

## ğŸ” IntegraciÃ³n con n8n

* Cada PDF genera **una ejecuciÃ³n independiente** en n8n.
* El webhook recibe un payload con:

```json
{
  "cliente": "Mediclick",
  "documento": "archivo.pdf",
  "imagenes": ["url1", "url2"]
}
```

ğŸ“Œ Las ejecuciones se visualizan en **Executions**, no siempre en el canvas en tiempo real.

---

## ğŸ“ Logs

* Consola y archivo `logs/app.log`
* Incluye:

  * PDFs procesados
  * PÃ¡ginas subidas
  * Errores de Cloudinary o n8n

---

## âœ… Buenas prÃ¡cticas implementadas

* EnvÃ­o **PDF por PDF** (mejor escalabilidad)
* Logs centralizados
* Manejo de errores
* Webhook en producciÃ³n
* Arquitectura lista para crecer

---

## ğŸ“Œ Notas finales

* El sistema estÃ¡ preparado para escalar
* Para grandes volÃºmenes se recomienda:

  * colas (Redis / RabbitMQ)
  * workers
  * base de datos para tracking

---

ğŸ‘¨â€ğŸ’» Proyecto listo para producciÃ³n y mantenimiento.

Si tienes dudas, revisa los logs o las ejecuciones en n8n.
